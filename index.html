<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Duel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        .container { transition: opacity 0.5s; }
        .hidden { display: none; opacity: 0; }
        .visible { display: block; opacity: 1; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="app" class="max-w-2xl mx-auto p-4 sm:p-6 lg:p-8">

        <h1 class="text-4xl font-bold text-center text-blue-600 mb-8">Quiz Duel</h1>

        <!-- ======================= -->
        <!--  Authentication Section -->
        <!-- ======================= -->
        <div id="auth-container" class="container visible bg-white p-8 rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold text-center mb-6">Login or Register</h2>
            <div class="space-y-4">
                <input type="text" id="username" placeholder="Username" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex justify-center space-x-4 mt-6">
                <button id="login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">Login</button>
                <button id="register-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg">Register</button>
            </div>
        </div>

        <!-- ======================= -->
        <!--      Lobby Section      -->
        <!-- ======================= -->
        <div id="lobby-container" class="container hidden bg-white p-8 rounded-xl shadow-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold">Welcome, <span id="lobby-username" class="text-blue-600"></span>!</h2>
                <button id="logout-btn" class="text-sm text-red-500 hover:underline">Logout</button>
            </div>
            <div class="space-y-6">
                <div class="p-4 border rounded-lg">
                    <h3 class="font-semibold mb-2">Play a Game</h3>
                    <div class="flex items-center space-x-4">
                        <button id="create-game-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex-1">Create New Game</button>
                        <div class="flex-1">
                            <input type="text" id="invite-code" placeholder="Enter Invite Code" class="w-full px-3 py-2 border rounded-lg">
                            <button id="join-game-btn" class="mt-2 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Join Game</button>
                        </div>
                    </div>
                </div>
                <div class="p-4 border rounded-lg">
                    <h3 class="font-semibold mb-2">Game History</h3>
                    <button id="history-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">View My Games</button>
                    <div id="history-list" class="mt-4 space-y-2"></div>
                </div>
                <div class="p-4 border rounded-lg">
                    <h3 class="font-semibold mb-2">My Preferences</h3>
                    <p class="text-sm text-gray-600 mb-2">Select your favorite quiz categories.</p>
                    <div id="categories-checkboxes" class="grid grid-cols-2 gap-2">
                    </div>
                    <button id="save-prefs-btn" class="mt-4 w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">Save Preferences</button>
                </div>
            </div>
        </div>

        <!-- ======================= -->
        <!--       Game Section      -->
        <!-- ======================= -->
        <div id="game-container" class="container hidden bg-white p-8 rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold text-center">Game in Progress</h2>
            <p class="text-center text-gray-600 mb-2">Invite Code: <span id="game-invite-code" class="font-mono bg-gray-200 px-2 py-1 rounded"></span></p>
            <div id="websocket-log" class="text-center text-sm text-purple-600 h-6 mb-4"></div>
            
            <div id="waiting-room" class="text-center">
                <p class="text-lg mb-4">Waiting for another player to join...</p>
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
            </div>

            <div id="question-area" class="hidden">
                 <p class="text-right font-semibold mb-2">Question <span id="question-number"></span>/10</p>
                <div class="bg-gray-100 p-4 rounded-lg mb-4">
                    <p id="question-text" class="text-xl text-center"></p>
                </div>
                <div id="options-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                </div>
            </div>
        </div>

        <!-- ======================= -->
        <!--     Summary Section     -->
        <!-- ======================= -->
        <div id="summary-container" class="container hidden bg-white p-8 rounded-xl shadow-md text-center">
            <h2 class="text-3xl font-bold mb-4">Game Over!</h2>
            <h3 class="text-2xl mb-6">Winner: <span id="winner-name" class="text-green-500"></span></h3>
            <div id="score-summary" class="space-y-2 text-lg">
            </div>
            <button id="back-to-lobby-btn" class="mt-8 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">Back to Lobby</button>
        </div>

        <div id="message-display" class="mt-4 text-center text-red-500 font-semibold"></div>

    </div>

    <script>
        // ===================================================================================
        //                                  GLOBAL STATE & CONFIG
        // ===================================================================================
        const API_BASE_URL = 'http://localhost:8080';
        let jwtToken = null;
        let currentGameId = null;
        let currentQuestionIndex = 0;
        let stompClient = null;
        let currentUser = null;

        const ALL_CATEGORIES = ['Science', 'History', 'Technology', 'Geography'];

        // ===================================================================================
        //                                  DOM ELEMENTS
        // ===================================================================================
        const containers = {
            auth: document.getElementById('auth-container'),
            lobby: document.getElementById('lobby-container'),
            game: document.getElementById('game-container'),
            summary: document.getElementById('summary-container'),
        };
        const messageDisplay = document.getElementById('message-display');

        // ===================================================================================
        //                                  UI CONTROL
        // ===================================================================================
        function showContainer(containerName) {
            Object.values(containers).forEach(c => c.classList.replace('visible', 'hidden'));
            if (containers[containerName]) {
                containers[containerName].classList.replace('hidden', 'visible');
            }
            messageDisplay.textContent = ''; 
        }

        function displayMessage(message, isError = true) {
            messageDisplay.textContent = message;
            messageDisplay.style.color = isError ? '#ef4444' : '#10b981';
        }

        // ===================================================================================
        //                                  API HELPER
        // ===================================================================================
        async function apiRequest(endpoint, method = 'GET', body = null) {
            const headers = { 'Content-Type': 'application/json' };
            if (jwtToken) {
                headers['Authorization'] = `Bearer ${jwtToken}`;
            }

            const config = {
                method,
                headers,
                body: body ? JSON.stringify(body) : null,
            };

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(errorData || `HTTP error! Status: ${response.status}`);
                }
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    return await response.json();
                } else {
                    return await response.text();
                }
            } catch (error) {
                console.error('API Request Error:', error.message);
                displayMessage(error.message);
                throw error;
            }
        }

        // ===================================================================================
        //                                  AUTHENTICATION
        // ===================================================================================
        document.getElementById('register-btn').addEventListener('click', async () => {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            try {
                await apiRequest('/api/users/register', 'POST', { username, password });
                displayMessage('Registration successful! Please log in.', false);
            } catch (error) { /* Handled by apiRequest */ }
        });

        document.getElementById('login-btn').addEventListener('click', async () => {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            try {
                const token = await apiRequest('/api/users/login', 'POST', { username, password });
                jwtToken = token;
                currentUser = username;
                document.getElementById('lobby-username').textContent = username;
                await loadUserProfile();
                showContainer('lobby');
            } catch (error) { /* Handled by apiRequest */ }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            jwtToken = null;
            currentUser = null;
            currentGameId = null;
            if(stompClient) stompClient.disconnect();
            showContainer('auth');
        });
		document.getElementById('history-btn').addEventListener('click', async () => {
		        try {
		            const history = await apiRequest('/api/users/me/history');
		            const listEl = document.getElementById('history-list');
		            if (history.length === 0) {
		                listEl.innerHTML = '<p class="text-gray-500">No finished games yet.</p>';
		                return;
		            }

		            listEl.innerHTML = history.map(game => {
		                let resultColor = 'text-gray-500'; // Tie
		                if (game.result === 'Win') {
		                    resultColor = 'text-green-500';
		                } else if (game.result === 'Loss') {
		                    resultColor = 'text-red-500';
		                }

		                return `
		                    <div class="p-3 border-b grid grid-cols-3 gap-2 items-center text-center">
		                        <div>
		                            <p class="text-sm text-gray-500">vs ${game.opponentUsername}</p>
		                        </div>
		                        <div>
		                            <p class="font-semibold">${game.myScore} - ${game.opponentScore}</p>
		                        </div>
		                        <div>
		                            <p class="font-bold ${resultColor}">${game.result}</p>
		                        </div>
		                    </div>
		                `;
		            }).join('');
		        } catch (error) { /* Handled by apiRequest */ }
		    });

        // ===================================================================================
        //                                  USER PROFILE & LOBBY
        // ===================================================================================
        function renderCategoryCheckboxes(preferredCategories = []) {
            const container = document.getElementById('categories-checkboxes');
            container.innerHTML = '';
            ALL_CATEGORIES.forEach(cat => {
                const isChecked = preferredCategories.includes(cat);
                container.innerHTML += `
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" value="${cat}" class="form-checkbox h-5 w-5 text-indigo-600" ${isChecked ? 'checked' : ''}>
                        <span>${cat}</span>
                    </label>
                `;
            });
        }

        async function loadUserProfile() {
            try {
                const profile = await apiRequest('/api/users/me');
                let preferred = [];
                if (profile.preferredCategories) {
                    preferred = JSON.parse(profile.preferredCategories);
                }
                renderCategoryCheckboxes(preferred);
            } catch (error) {
                 renderCategoryCheckboxes();
            }
        }

        document.getElementById('save-prefs-btn').addEventListener('click', async () => {
            const checkboxes = document.querySelectorAll('#categories-checkboxes input:checked');
            const selectedCategories = Array.from(checkboxes).map(cb => cb.value);
            try {
                await apiRequest('/api/users/me', 'PATCH', { preferredCategories: JSON.stringify(selectedCategories) });
                displayMessage('Preferences saved!', false);
            } catch (error) { /* Handled */ }
        });

        document.getElementById('history-btn').addEventListener('click', async () => {
            try {
                const history = await apiRequest('/api/users/me/history');
                const listEl = document.getElementById('history-list');
                if (history.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500">No games played yet.</p>';
                    return;
                }
                listEl.innerHTML = history.map(game => `
                    <div class="p-2 border-b">
                        <p>Game ID: ${game.id} - Status: ${game.status}</p>
                        <p class="text-sm text-gray-500">Played on: ${new Date(game.createdAt).toLocaleString()}</p>
                    </div>
                `).join('');
            } catch (error) { /* Handled */ }
        });

        // ===================================================================================
        //                                  GAME FLOW
        // ===================================================================================
        document.getElementById('create-game-btn').addEventListener('click', async () => {
            try {
                const game = await apiRequest('/api/games/create', 'POST');
                enterGame(game.id, game.inviteCode);
            } catch (error) { /* Handled */ }
        });

        document.getElementById('join-game-btn').addEventListener('click', async () => {
            const inviteCode = document.getElementById('invite-code').value;
            if (!inviteCode) {
                displayMessage('Please enter an invite code.');
                return;
            }
            try {
                const game = await apiRequest(`/api/games/join?inviteCode=${inviteCode}`, 'POST');
                enterGame(game.id, game.inviteCode);
            } catch (error) { /* Handled */ }
        });

        async function enterGame(gameId, inviteCode) {
            currentGameId = gameId;
            document.getElementById('game-invite-code').textContent = inviteCode;
            document.getElementById('question-area').classList.add('hidden');
            document.getElementById('waiting-room').classList.remove('hidden');
            showContainer('game');
            connectWebSocket();

            try {
                const game = await apiRequest(`/api/games/${gameId}/summary`); 
                if (game.status === 'ACTIVE') {
                    console.log('Game is already active. Starting quiz.');
                    fetchQuestion(0);
                }
            } catch (error) {
                console.error("Could not fetch initial game state:", error);
            }
        }

        async function fetchQuestion(index) {
            try {
                const question = await apiRequest(`/api/games/${currentGameId}/question/${index}`);
                renderQuestion(question, index);
            } catch (error) { /* Handled */ }
        }

        function renderQuestion(question, index) {
            currentQuestionIndex = index;
            document.getElementById('question-number').textContent = index + 1;
            document.getElementById('question-text').textContent = question.text;
            
            const optionsContainer = document.getElementById('options-container');
            const options = JSON.parse(question.options);
            optionsContainer.innerHTML = '';
            options.forEach((option, i) => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('p-4', 'border', 'rounded-lg', 'text-left', 'hover:bg-blue-100', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-500');
                button.onclick = () => submitAnswer(i);
                optionsContainer.appendChild(button);
            });

            document.getElementById('waiting-room').classList.add('hidden');
            document.getElementById('question-area').classList.remove('hidden');
        }

        async function submitAnswer(chosenIndex) {
            document.querySelectorAll('#options-container button').forEach(b => b.disabled = true);
            try {
                await apiRequest(`/api/games/${currentGameId}/answer`, 'POST', {
                    questionIndex: currentQuestionIndex,
                    chosenIndex: chosenIndex
                });

                if (currentQuestionIndex < 9) {
                    fetchQuestion(currentQuestionIndex + 1);
                } else {
                    document.getElementById('question-area').innerHTML = '<p class="text-center text-lg">Quiz finished! Waiting for opponent...</p>';
                    pollForSummary();
                }
            } catch (error) { /* Handled */ }
        }

        async function pollForSummary() {
            const interval = setInterval(async () => {
                try {
                    const summary = await apiRequest(`/api/games/${currentGameId}/summary`);
                    if (summary.status === 'FINISHED') {
                        clearInterval(interval);
                        renderSummary(summary);
                    }
                } catch (error) {
                    clearInterval(interval);
                }
            }, 3000);
        }

        function renderSummary(summary) {
            document.getElementById('winner-name').textContent = summary.winnerUsername;
            const scoreEl = document.getElementById('score-summary');
            scoreEl.innerHTML = summary.playerScores.map(p => `
                <p>${p.username}: <span class="font-bold">${p.score} Points</span></p>
            `).join('');
            showContainer('summary');
        }

        document.getElementById('back-to-lobby-btn').addEventListener('click', () => {
            currentGameId = null;
            currentQuestionIndex = 0;
            if(stompClient) stompClient.disconnect();
            showContainer('lobby');
        });

        // ===================================================================================
        //                                  WEBSOCKETS
        // ===================================================================================
        function connectWebSocket() {
            const socket = new SockJS(`${API_BASE_URL}/ws`);
            stompClient = Stomp.over(socket);
            stompClient.connect({}, frame => {
                console.log('Connected: ' + frame);
                document.getElementById('websocket-log').textContent = 'Connected to game...';
                
                stompClient.subscribe(`/topic/game/${currentGameId}`, message => {
                    const body = message.body;
                    console.log('WS Message:', body);
                    document.getElementById('websocket-log').textContent = body;

                    if (body.includes('Game has started')) {
                        fetchQuestion(0);
                    }
                });
            }, error => {
                console.error('STOMP error', error);
                document.getElementById('websocket-log').textContent = 'Connection error!';
            });
        }

        // ===================================================================================
        //                                  INITIALIZATION
        // ===================================================================================
        document.addEventListener('DOMContentLoaded', () => {
            showContainer('auth');
        });

    </script>
</body>
</html>
